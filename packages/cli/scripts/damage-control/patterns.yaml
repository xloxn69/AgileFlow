# AgileFlow Damage Control - Security Patterns
#
# This file defines patterns for blocking destructive commands and protecting
# sensitive paths. The damage control hooks read this file to determine
# whether to allow, block, or ask for confirmation before executing commands.
#
# Exit codes from hooks:
#   0 = Allow command to proceed
#   2 = Block command (show error to user)
#
# To ask for confirmation, hooks output JSON: {"result": "ask", "message": "..."}

# ============================================================================
# BASH TOOL PATTERNS
# ============================================================================
# Regex patterns to match against bash commands
# If matched with ask: false (or no ask key), command is BLOCKED
# If matched with ask: true, user is asked for confirmation

bashToolPatterns:
  # Recursive/force deletion
  - pattern: '\brm\s+-[rRf]'
    reason: "rm with recursive or force flags can destroy entire directories"

  - pattern: '\brm\s+.*--no-preserve-root'
    reason: "rm with --no-preserve-root is catastrophically dangerous"

  - pattern: '\brm\s+-rf\s+/'
    reason: "rm -rf on root directory would destroy the entire system"

  # SQL destructive commands without WHERE clause
  - pattern: 'DELETE\s+FROM\s+\w+\s*;'
    reason: "DELETE without WHERE clause would delete all records"

  - pattern: 'TRUNCATE\s+(TABLE\s+)?\w+'
    reason: "TRUNCATE removes all data from table"

  - pattern: 'DROP\s+(TABLE|DATABASE|SCHEMA|INDEX)'
    reason: "DROP commands permanently destroy database objects"

  # Git force operations
  - pattern: 'git\s+push\s+.*--force'
    reason: "Force push can overwrite remote history"
    ask: true

  - pattern: 'git\s+push\s+.*-f\b'
    reason: "Force push can overwrite remote history"
    ask: true

  - pattern: 'git\s+reset\s+--hard'
    reason: "Hard reset discards uncommitted changes"
    ask: true

  # Format/wipe operations
  - pattern: '\bmkfs\b'
    reason: "mkfs formats filesystems, destroying all data"

  - pattern: '\bdd\s+.*of=/dev/'
    reason: "dd writing to device can destroy disk data"

  - pattern: '\bshred\b'
    reason: "shred permanently destroys file data"

  # Credential/secret exposure
  - pattern: 'cat\s+.*\.env'
    reason: "Displaying .env may expose secrets"
    ask: true

  - pattern: 'cat\s+.*/\.ssh/'
    reason: "Displaying SSH keys is a security risk"

  - pattern: 'cat\s+.*/credentials'
    reason: "Displaying credentials files is a security risk"

  # Cloud CLI destructive operations
  - pattern: 'aws\s+s3\s+rm\s+--recursive'
    reason: "Recursive S3 delete can destroy entire buckets"
    ask: true

  - pattern: 'aws\s+ec2\s+terminate-instances'
    reason: "Terminating EC2 instances is irreversible"
    ask: true

  - pattern: 'gcloud\s+.*delete'
    reason: "GCloud delete operations may be destructive"
    ask: true

  # Docker cleanup commands
  - pattern: 'docker\s+system\s+prune\s+-a'
    reason: "Docker prune -a removes all unused images"
    ask: true

  - pattern: 'docker\s+volume\s+rm'
    reason: "Docker volume removal may delete persistent data"
    ask: true

  # npm/package manager dangerous commands
  - pattern: 'npm\s+unpublish'
    reason: "npm unpublish can break dependent packages"
    ask: true

  - pattern: 'npm\s+deprecate'
    reason: "npm deprecate affects package visibility"
    ask: true

# ============================================================================
# ASK PATTERNS (CONFIRMATION REQUIRED)
# ============================================================================
# These patterns trigger a confirmation prompt but don't block by default

askPatterns:
  - pattern: 'DELETE\s+FROM\s+\w+\s+WHERE'
    reason: "Deleting specific records - confirm data is correct"

  - pattern: 'UPDATE\s+\w+\s+SET'
    reason: "Updating records - confirm scope is correct"

  - pattern: 'npm\s+publish'
    reason: "Publishing to npm is permanent"

  - pattern: 'git\s+tag\s+-d'
    reason: "Deleting git tags"

  - pattern: 'kubectl\s+delete'
    reason: "Kubernetes delete operations"

# ============================================================================
# PATH PROTECTION
# ============================================================================
# Three protection levels:
#   zeroAccessPaths: Cannot read, write, edit, or delete
#   readOnlyPaths: Can read, cannot modify or delete
#   noDeletePaths: Can read and modify, cannot delete

zeroAccessPaths:
  # System credentials
  - ~/.ssh/
  - ~/.gnupg/
  - ~/.aws/credentials
  - ~/.config/gcloud/

  # Environment secrets
  - .env
  - .env.local
  - .env.production
  - .env.*.local

  # Secret files
  - '**/secrets/**'
  - '**/credentials/**'
  - '**/*.pem'
  - '**/*.key'
  - '**/id_rsa'
  - '**/id_ed25519'

readOnlyPaths:
  # System config
  - /etc/
  - ~/.bashrc
  - ~/.zshrc
  - ~/.profile

  # Package locks (should use npm install, not edit directly)
  - package-lock.json
  - yarn.lock
  - pnpm-lock.yaml

  # Git internals
  - .git/

noDeletePaths:
  # AgileFlow core
  - .agileflow/
  - .agileflow/config.json
  - .agileflow/scripts/

  # Claude Code hooks and commands
  - .claude/
  - .claude/hooks/
  - .claude/commands/
  - .claude/settings.json

  # Project documentation (can edit, can't delete)
  - docs/09-agents/status.json
  - CLAUDE.md
  - AGENTS.md

# ============================================================================
# AGILEFLOW-SPECIFIC PROTECTION
# ============================================================================
# Additional patterns specific to AgileFlow projects

agileflowPatterns:
  # Protect AgileFlow infrastructure
  - pattern: 'rm.*\.agileflow'
    reason: "Deleting .agileflow would break AgileFlow installation"

  - pattern: 'rm.*\.claude'
    reason: "Deleting .claude would break Claude Code configuration"

  - pattern: 'rm.*status\.json'
    reason: "Deleting status.json would lose story tracking data"

  # Dangerous npm operations in AgileFlow context
  - pattern: 'npm\s+uninstall\s+agileflow'
    reason: "Uninstalling AgileFlow - confirm this is intentional"
    ask: true

# ============================================================================
# CONFIGURATION
# ============================================================================
# Settings for the damage control system

config:
  # Log blocked commands for pattern refinement
  logBlocked: true
  logPath: .agileflow/logs/damage-control.log

  # Show detailed reason when blocking
  showBlockReason: true

  # Timeout for hook execution (seconds)
  hookTimeout: 5

  # Enable/disable prompt hooks (AI-based evaluation)
  promptHooksEnabled: false
  promptHookMessage: "Evaluate if this command could cause irreversible damage. Block if dangerous."
