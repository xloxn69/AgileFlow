#!/bin/bash
# AgileFlow Development Environment Initialization
# Generated by AgileFlow session harness
# This script sets up your development environment for consistent sessions

set -e

echo "üöÄ Initializing development environment..."

# Detect project type and install dependencies
# This section will be customized based on your project

# Node.js projects
if [ -f "package-lock.json" ]; then
  echo "üì¶ Installing dependencies (npm ci)..."
  npm ci
elif [ -f "yarn.lock" ]; then
  echo "üì¶ Installing dependencies (yarn)..."
  yarn install --frozen-lockfile
elif [ -f "pnpm-lock.yaml" ]; then
  echo "üì¶ Installing dependencies (pnpm)..."
  pnpm install --frozen-lockfile
elif [ -f "package.json" ]; then
  echo "üì¶ Installing dependencies (npm install)..."
  npm install
fi

# Python projects
if [ -f "requirements.txt" ]; then
  echo "üì¶ Installing Python dependencies..."
  pip install -r requirements.txt
fi

if [ -f "poetry.lock" ]; then
  echo "üì¶ Installing Poetry dependencies..."
  poetry install
fi

# Rust projects
if [ -f "Cargo.toml" ]; then
  echo "üì¶ Building Rust project..."
  cargo build
fi

# Go projects
if [ -f "go.mod" ]; then
  echo "üì¶ Downloading Go modules..."
  go mod download
fi

# Run database migrations if applicable
if [ -f "migrations/run.sh" ]; then
  echo "üóÑÔ∏è  Running database migrations..."
  bash migrations/run.sh
fi

if [ -d "prisma" ] && [ -f "package.json" ]; then
  if command -v npx &> /dev/null; then
    echo "üóÑÔ∏è  Running Prisma migrations..."
    npx prisma migrate deploy 2>/dev/null || echo "‚ö†Ô∏è  Prisma migrations skipped"
  fi
fi

# Environment setup
if [ -f ".env.example" ] && [ ! -f ".env" ]; then
  echo "‚öôÔ∏è  Creating .env from .env.example..."
  cp .env.example .env
  echo "‚ö†Ô∏è  Please configure .env with your settings"
fi

echo "‚úÖ Environment initialization complete"
echo ""
echo "Next steps:"
echo "  - Run tests: Check environment.json for test_command"
echo "  - Start dev server: Check environment.json for dev_server.command"
echo "  - Review .env: Ensure environment variables are configured"
