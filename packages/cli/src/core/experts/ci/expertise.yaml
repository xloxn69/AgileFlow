domain: ci
last_updated: 2025-12-21
version: 1.1

# AgileFlow-specific CI/CD configuration (learned from actual codebase)
files:
  workflows:
    - path: .github/workflows/npm-publish.yml
      purpose: Automated npm publish on git tag
      trigger: "push to tags matching v*.*.*"
      jobs: ["publish-npm"]
      key_steps:
        - "Checkout repository"
        - "Setup Node.js 18 with npm registry"
        - "Extract version from tag"
        - "Verify package.json version matches tag"
        - "Install dependencies (if package-lock.json exists)"
        - "Publish to npm with NPM_TOKEN secret"
        - "Generate summary report"
      secrets: ["NPM_TOKEN"]

  config:
    - path: packages/cli/package.json
      purpose: Main package config with scripts
      key_scripts:
        - "postinstall: node tools/postinstall.js"
        - "agileflow: node tools/agileflow-npx.js"
        - "lint: (not configured yet)"
        - "test: (not configured yet)"
    - path: .npmrc
      purpose: npm config (local, gitignored)

  validation:
    - path: scripts/validate-expertise.sh
      purpose: Validate agent expertise files
      checks:
        - "File existence"
        - "YAML validity"
        - "Learnings populated"
        - "Staleness (age of last_updated)"
    - path: scripts/expertise-metrics.sh
      purpose: Dashboard for expertise health

relationships:
  - name: tag_triggers_publish
    trigger: "git tag v*.*.*"
    workflow: ".github/workflows/npm-publish.yml"
    action: "Publish to npm registry"

  - name: version_verification
    step: "Verify package.json version matches tag"
    files: ["packages/cli/package.json"]
    failure_action: "Exit with error, block publish"

  - name: secret_management
    secret: "NPM_TOKEN"
    location: "GitHub Secrets"
    usage: "npm publish --access public"

patterns:
  - name: Tag-Based Release
    description: "Git tags v*.*.* trigger GitHub Actions"
    workflow_file: ".github/workflows/npm-publish.yml"

  - name: Version Verification
    description: "CI verifies package.json matches tag before publish"
    prevents: "Mismatched version numbers"

  - name: Conditional Install
    description: "Only run npm ci if package-lock.json exists"
    avoids: "Unnecessary install step"

  - name: GitHub Step Summary
    description: "Workflow outputs summary to GITHUB_STEP_SUMMARY"
    provides: "Visible publish confirmation in Actions UI"

conventions:
  - "Trigger workflows on tag push (v*.*.*), not branch push"
  - "Verify version matches between package.json and git tag"
  - "Use NPM_TOKEN from GitHub Secrets (never commit)"
  - "Publish with --access public for scoped packages"
  - "Generate GITHUB_STEP_SUMMARY for visibility"
  - "Node.js 18 is the target runtime"
  - "Monorepo: publish from packages/cli/ directory"

# Learned from AgileFlow codebase exploration
learnings:
  - date: 2025-12-21
    context: "Analyzed npm-publish.yml workflow"
    insight: "Workflow verifies package.json version matches tag before publishing to prevent mismatches"
    source: ".github/workflows/npm-publish.yml"

  - date: 2025-12-21
    context: "Analyzed CI trigger pattern"
    insight: "Uses tag-based publishing (v*.*.*) rather than branch push - cleaner release control"
    source: ".github/workflows/npm-publish.yml"

  - date: 2025-12-21
    context: "Analyzed monorepo structure"
    insight: "npm publish runs from packages/cli/ (working-directory), not root"
    source: ".github/workflows/npm-publish.yml"

  - date: 2025-12-21
    context: "Analyzed validation tooling"
    insight: "validate-expertise.sh and expertise-metrics.sh provide CI-style checks for agent expertise files"
    source: "scripts/"
