# Database Expert - Mental Model
#
# This file represents the agent's understanding of database patterns.
# It is populated with AgileFlow-generic knowledge and learns project-specific
# details through the self-improve workflow.
#
# NOT a source of truth - always validate against actual code.

domain: database
last_updated: 2025-12-21
version: 1.1

# Key files the database expert needs to know
files:
  schemas:
    - path: src/db/schema.ts
      purpose: Database table definitions (if using Drizzle/TypeORM)
      key_exports: [tables, relations]
    - path: prisma/schema.prisma
      purpose: Prisma schema file (if using Prisma)
      conventions: "model declarations with @id, @relation"
    - path: src/models/
      purpose: Model definitions (if using Mongoose/Sequelize)
      pattern: "<ModelName>.model.ts"

  migrations:
    - path: src/db/migrations/
      purpose: Schema migration scripts
      pattern: "YYYYMMDD_description.ts"
    - path: prisma/migrations/
      purpose: Prisma migration history
      conventions: "Auto-generated, don't edit"

  queries:
    - path: src/db/queries/
      purpose: Database query functions
      conventions: "One file per table/resource"
    - path: src/repositories/
      purpose: Repository pattern implementations
      pattern: "<Resource>Repository.ts"

  seeds:
    - path: src/db/seeds/
      purpose: Seed data for development/testing
      conventions: "Idempotent, can run multiple times"

  # AgileFlow-specific JSON data stores (not SQL databases)
  json_stores:
    - path: docs/09-agents/status.json
      purpose: "Story and epic tracking (AgileFlow's 'database')"
      schema:
        updated: "ISO timestamp"
        epics: "Map of EP-ID to {title, status, completed, summary}"
        stories: "Map of US-ID to {title, epic, owner, status, priority, estimate, depends_on, test_status}"
    - path: docs/09-agents/bus/log.jsonl
      purpose: "Agent coordination messages (append-only log)"
      format: "JSON Lines, one message per line"
    - path: docs/09-agents/archive/
      purpose: "Archived completed stories by month"
      pattern: "YYYY-MM.json"

# Common database relationships
# Self-improve will populate project-specific relationships
relationships:
  # AgileFlow JSON relationships
  - parent: epics
    child: stories
    type: one-to-many
    key: "stories[*].epic references epics[EP-ID]"
  - parent: stories
    child: test_cases
    type: one-to-one
    location: "docs/07-testing/test-cases/"

# Database patterns the expert should recognize and follow
patterns:
  - name: "Soft deletes"
    description: "Use deleted_at timestamp instead of hard DELETE"
    location: Tables with user data
    applies_to: [users, posts, comments]

  - name: "Timestamps"
    description: "All tables have created_at and updated_at"
    location: Every table
    convention: "Auto-managed by ORM or triggers"

  - name: "UUID primary keys"
    description: "Use UUIDs instead of auto-increment for distributed systems"
    location: Primary key columns
    alternative: "Auto-increment for simpler setups"

  - name: "Foreign key naming"
    description: "Foreign keys follow <table_singular>_id pattern"
    location: All relationship columns
    example: "user_id, post_id, category_id"

  - name: "Index naming"
    description: "Indexes follow idx_<table>_<columns> pattern"
    location: Index definitions
    example: "idx_users_email, idx_posts_user_id_created_at"

  - name: "JSON Single Source of Truth"
    description: "AgileFlow uses status.json as primary data store"
    location: docs/09-agents/status.json
    pattern: "Read-modify-write with updated timestamp"

  - name: "JSON Lines for Logs"
    description: "Append-only logs use .jsonl format"
    location: docs/09-agents/bus/log.jsonl
    pattern: "One JSON object per line, append only"

  - name: "Monthly Archival"
    description: "Completed stories archived by month to keep status.json lean"
    location: docs/09-agents/archive/YYYY-MM.json
    script: scripts/archive-completed-stories.sh

# Conventions the database expert should follow
conventions:
  - "Tables: lowercase, plural (users, posts, categories)"
  - "Columns: lowercase, snake_case (first_name, created_at)"
  - "Foreign keys: <table_singular>_id (user_id, post_id)"
  - "Required columns: id, created_at, updated_at"
  - "Soft delete column: deleted_at (nullable timestamp)"
  - "All queries use parameterized statements (prevent SQL injection)"
  - "Transactions for multi-table operations"
  - "Migrations must be reversible (up and down)"
  - "No SELECT * in production code"
  - "Index columns used in WHERE, JOIN, ORDER BY"
  - "JSON stores: always update 'updated' timestamp when modifying"
  - "JSON Lines: append only, never modify existing lines"

# Learned from AgileFlow codebase exploration
learnings:
  - date: 2025-12-21
    context: "Analyzed AgileFlow data storage"
    insight: "AgileFlow uses JSON files instead of SQL: status.json for tracking, log.jsonl for coordination, archive/ for historical data"
    source: "docs/09-agents/"

  - date: 2025-12-21
    context: "Analyzed status.json schema"
    insight: "Two main collections: epics (EP-ID keys) and stories (US-ID keys); stories have owner, status, priority, estimate, depends_on, test_status"
    source: "docs/09-agents/status.json"

  - date: 2025-12-21
    context: "Analyzed archival pattern"
    insight: "scripts/archive-completed-stories.sh moves done stories >7 days old to archive/YYYY-MM.json to keep status.json performant"
    source: "scripts/archive-completed-stories.sh, CLAUDE.md"

  - date: 2025-12-21
    context: "Analyzed JSON Lines pattern"
    insight: "bus/log.jsonl uses append-only JSON Lines format for agent messages; each line is independent JSON object"
    source: "docs/09-agents/bus/log.jsonl"
