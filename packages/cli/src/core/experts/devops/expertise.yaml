domain: devops
last_updated: 2025-12-21
version: 1.1

# AgileFlow-specific file structure (learned from actual codebase)
files:
  release:
    - path: scripts/release.sh
      purpose: Automated release script (version bump, tag, GitHub release)
      key_steps:
        - "Bump version in packages/cli/package.json"
        - "Bump version in root package.json"
        - "Commit and push to main"
        - "Create and push git tag v*.*.*"
        - "Create GitHub release with gh CLI"
      usage: "./scripts/release.sh 2.32.0 'Feature Name'"

  scripts:
    - path: scripts/agileflow-statusline.sh
      purpose: Claude Code status bar script
    - path: scripts/archive-completed-stories.sh
      purpose: Auto-archive old completed stories from status.json
    - path: scripts/compress-status.sh
      purpose: Compress status.json by removing verbose fields
    - path: scripts/validate-expertise.sh
      purpose: Validate expertise.yaml files for staleness/completeness
    - path: scripts/expertise-metrics.sh
      purpose: Dashboard for agent expertise health
    - path: scripts/get-env.js
      purpose: Session start hook - outputs project environment info

  package_management:
    - path: packages/cli/package.json
      purpose: Main npm package definition (agileflow)
      version_source: true
    - path: package.json
      purpose: Root monorepo package.json (version must match)
      note: "Version synced with release.sh"

  ci_cd:
    - path: .github/workflows/npm-publish.yml
      purpose: Automated npm publish on git tag push
      trigger: "push to tags matching v*.*.*"
      secrets: ["NPM_TOKEN"]

relationships:
  - name: version_sync
    files: ["packages/cli/package.json", "package.json"]
    rule: "Version must match in both files"
    tooling: "scripts/release.sh handles this automatically"

  - name: tag_to_release
    trigger: "git tag v*.*.*"
    action: "GitHub Actions publishes to npm"
    verification: "npm view agileflow version"

  - name: auto_archival
    trigger: "Session start hook"
    script: "scripts/archive-completed-stories.sh"
    threshold: "7 days"
    destination: "docs/09-agents/archive/YYYY-MM.json"

patterns:
  - name: Automated Release
    description: "Use release.sh for all releases - never manual"
    command: "./scripts/release.sh <version> 'Title'"

  - name: Version Sync
    description: "Version in 2 files: packages/cli/package.json and package.json"

  - name: Tag-Based Publishing
    description: "GitHub Actions publishes to npm when v*.*.* tag pushed"

  - name: Hook-Based Automation
    description: "Session hooks run scripts on Claude Code startup"

conventions:
  - "ALWAYS use scripts/release.sh for releases (never manual)"
  - "Version must match in packages/cli/package.json and root package.json"
  - "Git tags trigger npm publish (never publish manually)"
  - "NPM_TOKEN stored in GitHub Secrets, not local"
  - "Commits use conventional format (feat:, fix:, chore:)"
  - "NO AI attribution in commit messages (see CLAUDE.md)"

# Learned from AgileFlow codebase exploration
learnings:
  - date: 2025-12-21
    context: "Analyzed AgileFlow release process"
    insight: "release.sh automates entire release: version bump, commit, tag, GitHub release"
    source: "scripts/release.sh"

  - date: 2025-12-21
    context: "Analyzed npm publish workflow"
    insight: "npm-publish.yml verifies package.json version matches tag before publishing"
    source: ".github/workflows/npm-publish.yml"

  - date: 2025-12-21
    context: "Analyzed utility scripts"
    insight: "12+ shell/JS scripts in scripts/ for automation: archival, validation, metrics, status line"
    source: "scripts/"

  - date: 2025-12-21
    context: "Analyzed session hooks"
    insight: "get-env.js outputs project info on session start; archive-completed-stories.sh runs automatically"
    source: "CLAUDE.md, .claude/settings.json"
