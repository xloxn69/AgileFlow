---
title: Damage Control FAQ & Troubleshooting
description: Common questions and solutions for Damage Control.
---

# Damage Control FAQ & Troubleshooting

## Frequently Asked Questions

### General Questions

**Q: Does Damage Control slow down my commands?**

A: No, it adds less than 5ms per command. The pattern matching is highly optimized and happens before Claude Code even starts executing the tool.

**Q: Can I disable Damage Control temporarily?**

A: Yes, run:
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
```
Then restart Claude Code. You can re-enable it later with `--enable=damagecontrol`.

**Q: What if Damage Control blocks something that should be allowed?**

A: Edit `.agileflow/config/damage-control-patterns.yaml` and either:
1. Make the pattern more specific (narrower)
2. Move it from `bashToolPatterns` to `askPatterns`
3. Remove it entirely if it's not needed

Then restart Claude Code.

**Q: Does Damage Control protect against human mistakes or only AI?**

A: Damage Control protects against both. Any command or file operation goes through the hooks, whether initiated by you or an AI agent.

**Q: Can patterns be bypassed?**

A: Not easily. Patterns match the actual command string, so simple workarounds like `r m -rf` won't work (syntax error). More complex bypasses would require modifying the validation scripts.

**Q: What happens if the patterns file is corrupted?**

A: The scripts use "fail-open" philosophy - if the patterns file can't be parsed, commands are allowed. This ensures a broken safety system doesn't block all operations.

### Setup Questions

**Q: I enabled Damage Control but hooks aren't working. What's wrong?**

A: Most common cause: You haven't restarted Claude Code. Hooks only take effect after a complete restart.

1. Close Claude Code completely (Cmd+Q / Ctrl+Q)
2. Wait 5 seconds
3. Reopen Claude Code
4. Test with `rm -rf /` (should be blocked)

**Q: How do I know if Damage Control is working?**

A: Test by running a blocked command:

```bash
# This should always be blocked
rm -rf /

# You should see:
# [BLOCKED] rm with absolute path - could delete system files
# Command: rm -rf /
```

**Q: I can't find the patterns file. Where should it be?**

A: It should be at:
```
.agileflow/config/damage-control-patterns.yaml
```

If it doesn't exist:
```bash
# Create it
mkdir -p .agileflow/config

# Copy from template
cp .agileflow/templates/damage-control-patterns.yaml .agileflow/config/

# Or enable damage control again
/agileflow:configure damagecontrol
```

**Q: My settings.json got corrupted. How do I fix it?**

A: Backup and restore:
```bash
# Backup the broken file
cp .claude/settings.json .claude/settings.json.broken

# Try to migrate
node .agileflow/scripts/agileflow-configure.js --migrate

# If that fails, start over
rm .claude/settings.json
/agileflow:configure damagecontrol
```

### Pattern Questions

**Q: How do I add a custom pattern?**

A: Edit `.agileflow/config/damage-control-patterns.yaml` and add to either section:

```yaml
# Always block
bashToolPatterns:
  - pattern: 'your-pattern-here'
    reason: "Why you're blocking this"

# Ask for confirmation first
askPatterns:
  - pattern: 'your-pattern-here'
    reason: "Why you want confirmation"
```

**Q: How do I test if my pattern works?**

A: Test in Node.js:

```bash
node -e "
const pattern = /your-regex-here/;
const command = 'test-command-here';
console.log('Match:', pattern.test(command));
"
```

**Q: What's the difference between `bashToolPatterns` and `askPatterns`?**

A:
- `bashToolPatterns` - Always blocks (exit code 2)
- `askPatterns` - Asks user for confirmation (outputs JSON)

Use `bashToolPatterns` for dangerous operations. Use `askPatterns` for risky but sometimes valid operations.

**Q: Can I have patterns that only match in certain contexts?**

A: Patterns are simple regex - they don't understand context. If you need context-aware blocking, you'd need custom validation code. For now, make patterns as specific as possible.

**Q: My pattern matches too many commands. How do I make it more specific?**

A: Use regex features to narrow the match:

```yaml
# Too broad
- pattern: 'delete'    # Matches everything with "delete"

# Better
- pattern: 'DELETE\s+FROM'  # Matches SQL DELETE statements

# Even better
- pattern: 'DELETE\s+FROM\s+\w+\s*;'  # Matches only DELETE with no WHERE
```

### Path Protection Questions

**Q: What's the difference between the three path protection levels?**

A:
- **Zero Access** - Cannot read, write, edit, or delete
- **Read-Only** - Can read, but cannot modify
- **No Delete** - Can read and modify, but cannot delete

Use Zero Access for secrets and credentials. Use Read-Only for infrastructure files. Use No Delete for important project files.

**Q: How do I protect all `.env.*` files?**

A: Add to `zeroAccessPaths`:

```yaml
zeroAccessPaths:
  - ".env.*"        # Matches .env.local, .env.production, etc.
  - ".env"          # Also protect bare .env
```

**Q: Can I protect a whole directory?**

A: Yes, use a trailing slash:

```yaml
zeroAccessPaths:
  - "~/.ssh/"       # Protects all files in ~/.ssh/
  - "/secrets/"     # Protects all files in /secrets/
```

**Q: How do I protect a file with special characters?**

A: Escape the special characters:

```yaml
zeroAccessPaths:
  - ".env.*.prod"   # Won't work - . is regex metachar
  - ".env\\..*\\.prod"  # Better - but complicated

# Just use simpler patterns
zeroAccessPaths:
  - ".env.prod"
  - ".env.production"
```

## Troubleshooting

### Symptom: Commands run despite Damage Control being enabled

**Issue:** You enabled Damage Control, but dangerous commands still execute.

**Diagnosis:**
1. Verify hooks are in settings:
   ```bash
   grep "damage-control" .claude/settings.json | wc -l
   # Should output 3
   ```

2. Verify patterns file exists:
   ```bash
   ls -la .agileflow/config/damage-control-patterns.yaml
   # Should exist and be readable
   ```

3. Check if Claude Code was restarted:
   ```bash
   # Try blocking something
   rm -rf /
   # Should see [BLOCKED] message
   ```

**Solutions:**

Option 1: Restart Claude Code
- Close completely (Cmd+Q)
- Wait 5 seconds
- Reopen
- Test again

Option 2: Manually verify hooks
```bash
# Check .claude/settings.json has hooks
cat .claude/settings.json | grep -A 10 "PreToolUse"
```

Option 3: Re-enable Damage Control
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
# Wait a moment
node .agileflow/scripts/agileflow-configure.js --enable=damagecontrol
# Restart Claude Code
```

### Symptom: Valid commands are being blocked

**Issue:** You get "[BLOCKED]" messages for commands that should be allowed.

**Diagnosis:**
1. Note the exact command that was blocked
2. Check which pattern matched:
   ```bash
   grep -B 2 "reason.*your-reason-here" .agileflow/config/damage-control-patterns.yaml
   ```

3. Test the pattern:
   ```bash
   node -e "
   const pattern = /your-pattern-here/;
   const cmd = 'your-command-here';
   console.log('Matches:', pattern.test(cmd));
   console.log('Pattern:', pattern.toString());
   "
   ```

**Solutions:**

Option 1: Make pattern more specific
```yaml
# Current (too broad)
- pattern: 'delete'

# Better (more specific)
- pattern: 'DELETE\s+FROM\s+\w+\s*;'
```

Option 2: Move to askPatterns
```yaml
# Instead of blocking, ask for confirmation
askPatterns:
  - pattern: 'your-pattern'
    reason: "Confirm this action?"
```

Option 3: Remove or comment out pattern
```yaml
# Comment it out for now
# - pattern: 'your-pattern'
#   reason: "Reason"

# Or remove entirely and test
```

### Symptom: "Scripts not found" error

**Error Message:**
```
Script not found: .agileflow/scripts/damage-control-bash.js
```

**Diagnosis:**
1. Check if scripts directory exists:
   ```bash
   ls -la .agileflow/scripts/damage-control*.js
   ```

2. Check if scripts are executable:
   ```bash
   file .agileflow/scripts/damage-control-bash.js
   # Should show: JavaScript source code
   ```

**Solutions:**

Option 1: Reinstall scripts
```bash
npx agileflow@latest update
```

Option 2: Repair scripts
```bash
node .agileflow/scripts/agileflow-configure.js --repair=damagecontrol
```

Option 3: Manual restore
```bash
# Copy from npm package (if installed locally)
cp node_modules/agileflow/scripts/damage-control*.js .agileflow/scripts/

# Or reinstall agileflow
npx agileflow@latest setup
```

### Symptom: Settings file validation errors

**Error Message:**
```
Cannot parse .claude/settings.json
Invalid JSON
```

**Diagnosis:**
1. Check file syntax:
   ```bash
   python -m json.tool .claude/settings.json > /dev/null
   # If error shown, JSON is invalid
   ```

2. View the file to spot issues:
   ```bash
   cat .claude/settings.json
   ```

**Solutions:**

Option 1: Auto-migrate
```bash
node .agileflow/scripts/agileflow-configure.js --migrate
```

Option 2: Manual fix
- Look for missing commas, quotes, brackets
- Use a JSON validator: https://jsonlint.com
- Fix the issues
- Verify: `python -m json.tool .claude/settings.json`

Option 3: Start over
```bash
# Backup broken file
cp .claude/settings.json .claude/settings.json.broken

# Start fresh
rm .claude/settings.json
/agileflow:configure damagecontrol
```

### Symptom: Timeout or slow responses

**Issue:** Damage Control hooks seem to timeout or slow everything down.

**Diagnosis:**
1. Check pattern count:
   ```bash
   grep "pattern:" .agileflow/config/damage-control-patterns.yaml | wc -l
   # If over 100, might be slow
   ```

2. Check for complex regex:
   ```bash
   grep "pattern:" .agileflow/config/damage-control-patterns.yaml | grep -E '\\\(|\\\)|\\\\[|\\\]'
   # Lots of escapes = complex patterns
   ```

**Solutions:**

Option 1: Reduce pattern count
- Remove unused patterns
- Combine similar patterns
- Use simpler patterns

Option 2: Simplify regex
```yaml
# Complex pattern (slow)
- pattern: '(^|;|\||\&\&)\s*rm\s+(-[rRf]+\s+)*[/\w\-\.]'

# Simpler pattern (faster)
- pattern: '\brm\s+-[rRf]*\s+/'
```

Option 3: Disable if necessary
```bash
node .agileflow/scripts/agileflow-configure.js --disable=damagecontrol
```

## Performance Optimization

### Pattern Ordering

Put commonly matched patterns first for faster matching:

```yaml
bashToolPatterns:
  # Most common destructive operations first
  - pattern: '\brm\s+-rf'       # Frequently checked
  - pattern: '\bgit\s+push.*force'
  - pattern: 'DROP\s+TABLE'

  # Less common operations later
  - pattern: '\bdd\s+if='
  - pattern: '\bmkfs'
```

### Pattern Simplification

Simple patterns are faster:

```yaml
# Avoid (complex)
- pattern: '(?:^|\s)(sudo\s+)?(?:bash|sh|zsh|ksh|tcsh|csh)\s+(?:-[a-zA-Z]*[cisx][a-zA-Z]*\s+)?["\''`].*(?:DROP|delete|remove).*["\''`]'

# Use instead (simple)
- pattern: '\bDROP\s+'
  flags: "i"
```

### Pattern Testing

Pre-test patterns before deployment:

```bash
# Quick test
node -e "
const p1 = /complex-pattern/;
const p2 = /simple-pattern/;
const cmd = 'test command';

console.time('complex');
for(let i=0; i<10000; i++) p1.test(cmd);
console.timeEnd('complex');

console.time('simple');
for(let i=0; i<10000; i++) p2.test(cmd);
console.timeEnd('simple');
"
```

## Advanced Troubleshooting

### Debug Mode

Enable verbose logging:

```bash
# Add to damage-control-bash.js (around line 190)
console.error('[DEBUG] Validating command:', command);
console.error('[DEBUG] Loaded patterns:', config.bashToolPatterns.length);

# Run test
echo '{"command":"rm -rf /"}' | node .agileflow/scripts/damage-control-bash.js
```

### Hook Investigation

Check if hook is actually being called:

```bash
# Add debug output before running command
cat > /tmp/test-hook.js << 'EOF'
console.log('Hook called with:', process.stdin.toString());
process.exit(0);
EOF

# Update .claude/settings.json temporarily to test
# Replace damage-control-bash.js with /tmp/test-hook.js

# Run a command and check output
```

### Pattern Regex Debugging

Test complex patterns in Node.js REPL:

```bash
node
# Now in REPL
> const pattern = /your-pattern/;
> pattern.test('test-string');
true
> pattern.source;
'your-pattern'
> pattern.flags;
''
```

## Performance Benchmarks

Typical overhead per command:

| Operation | Without | With | Overhead |
|-----------|---------|------|----------|
| Simple bash | 0ms | 2ms | 2ms |
| File write | 0ms | 3ms | 3ms |
| File edit | 0ms | 3ms | 3ms |

Note: These are unnoticeable to users. Total command time is dominated by the actual operation, not validation.

## Getting Help

If you're stuck:

1. Check this FAQ - most issues are covered
2. Review [Damage Control Setup Guide](/features/damage-control-setup)
3. Read [Architecture documentation](/features/damage-control-architecture)
4. Look at actual patterns in `.agileflow/config/damage-control-patterns.yaml`
5. Test patterns manually with Node.js REPL

## Feature Requests

Want Damage Control to handle something else?

- Add custom patterns to `.agileflow/config/damage-control-patterns.yaml`
- Test thoroughly before deployment
- Document why the pattern exists
- Share with your team

## Related Docs

- [Damage Control Overview](/features/damage-control)
- [Setup Guide](/features/damage-control-setup)
- [Architecture](/features/damage-control-architecture)
- [Configure Command](/commands/configure)
