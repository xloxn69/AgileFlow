flowchart TB
    subgraph Session["Claude Code Session"]
        U[User] -->|runs| CMD1["/babysit"]
        U -->|runs| CMD2["/epic"]
        CMD1 -->|STEP 0| REG1["Register in active_commands[]"]
        CMD2 -->|STEP 0| REG2["Add to active_commands[]"]
        REG1 --> STATE[(session-state.json)]
        REG2 --> STATE
    end

    subgraph Compact["Conversation Compaction"]
        TRIGGER[Context limit reached] -->|fires| HOOK["PreCompact Hook"]
        HOOK -->|runs| SCRIPT["precompact-context.sh"]
        SCRIPT -->|reads| STATE
        SCRIPT -->|extracts| SUM["Compact Summaries"]
        SUM -->|injects| CTX["Preserved Context"]
    end

    subgraph NewSession["New Session"]
        START[Session Start] -->|fires| CLEAR["clear-active-command.js"]
        CLEAR -->|resets| STATE
    end
