name: Release Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (e.g., 2.23.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 2.23.1)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Update plugin.json version
        run: |
          VERSION="${{ inputs.version }}"
          jq --arg version "$VERSION" '.version = $version' .claude-plugin/plugin.json > tmp.json
          mv tmp.json .claude-plugin/plugin.json
          echo "Updated plugin.json to $VERSION"

      - name: Update marketplace.json version
        run: |
          VERSION="${{ inputs.version }}"
          CURRENT_DESC=$(jq -r '.description' .claude-plugin/marketplace.json)
          NEW_DESC=$(echo "$CURRENT_DESC" | sed -E "s/\(v[0-9]+\.[0-9]+\.[0-9]+\)/(v$VERSION)/")
          jq --arg desc "$NEW_DESC" '.description = $desc' .claude-plugin/marketplace.json > tmp.json
          mv tmp.json .claude-plugin/marketplace.json
          echo "Updated marketplace.json to $VERSION"

      - name: Update README.md badge
        run: |
          VERSION="${{ inputs.version }}"
          sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+/version-$VERSION/" README.md
          echo "Updated README.md badge to $VERSION"

      - name: Verify CHANGELOG.md has section
        run: |
          VERSION="${{ inputs.version }}"
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "Error: CHANGELOG.md is missing [${VERSION}] section"
            echo "Please add a changelog entry for this version before releasing"
            exit 1
          fi
          echo "CHANGELOG.md has section for $VERSION"

      - name: Extract release notes from CHANGELOG
        run: |
          VERSION="${{ inputs.version }}"
          # Extract section between [VERSION] and next [X.Y.Z] section
          awk "/## \[$VERSION\]/,/## \[[0-9]/ {if (/## \[[0-9]/ && !/## \[$VERSION\]/) exit; print}" CHANGELOG.md > release-notes.txt
          echo "Extracted release notes:"
          cat release-notes.txt

      - name: Commit version bump
        run: |
          VERSION="${{ inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .claude-plugin/plugin.json .claude-plugin/marketplace.json README.md
          git commit -m "chore: release v$VERSION"

      - name: Create Git tag
        run: |
          VERSION="${{ inputs.version }}"
          git tag -a "v$VERSION" -F release-notes.txt
          echo "Created tag v$VERSION"

      - name: Push changes and tag
        run: |
          VERSION="${{ inputs.version }}"
          git push origin main
          git push origin "v$VERSION"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          gh release create "v$VERSION" \
            --title "Release v$VERSION" \
            --notes-file release-notes.txt \
            --latest

      - name: Summary
        run: |
          VERSION="${{ inputs.version }}"
          echo "## Release v$VERSION Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version bumped to $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git tag created: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub release published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
